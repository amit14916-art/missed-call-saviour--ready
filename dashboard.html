<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center | Missed Call Saviour</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #050a14;
            --bg-card: rgba(30, 41, 59, 0.4);
            --primary-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --glass-border: rgba(255, 255, 255, 0.08);
            --sidebar-width: 260px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            /* Prevent body scroll, let content scroll */
            background-image:
                radial-gradient(circle at 5% 10%, rgba(0, 198, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 95% 90%, rgba(0, 114, 255, 0.05) 0%, transparent 40%);
        }

        /* Glass Utility */
        .glass-panel {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
        }

        /* Layout */
        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 50px;
            display: block;
            text-decoration: none;
            letter-spacing: -0.02em;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 12px;
            color: var(--text-muted);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-item:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.03);
        }

        .menu-item.active {
            background: rgba(0, 198, 255, 0.1);
            color: #00c6ff;
            border: 1px solid rgba(0, 198, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        h2 {
            font-size: 1.8rem;
            margin: 0;
            font-weight: 600;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .status-inactive {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }

        /* Dashboard Grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            padding: 24px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: rgba(0, 198, 255, 0.3);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            line-height: 1;
        }

        /* Tables */
        .table-container {
            padding: 2px;
            /* Fix for border radius clipping if needed */
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 16px 24px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--glass-border);
        }

        td {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 0.95rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Forms */
        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        input,
        textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            padding: 12px 16px;
            border-radius: 12px;
            color: white;
            font-family: inherit;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #00c6ff;
        }

        .btn {
            background: var(--primary-gradient);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3);
        }

        /* Integration Cards */
        .integration-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .integration-card {
            padding: 30px;
            text-align: center;
        }

        .integration-status {
            margin-top: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 100px;
        }

        .is-connected {
            background: rgba(16, 185, 129, 0.1);
            color: #34d399;
        }

        .is-pending {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
        }

        /* Call Transcript Chat Bubbles */
        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        .chat-message.user {
            align-self: flex-end;
            align-items: flex-end;
        }

        .chat-message.ai {
            align-self: flex-start;
            align-items: flex-start;
        }

        .chat-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
        }

        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .chat-message.ai .chat-bubble {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 2px;
        }

        .chat-header {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 4px;
            font-weight: 600;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(251, 113, 133, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(251, 113, 133, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(251, 113, 133, 0);
            }
        }

        .live-card {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(251, 113, 133, 0.2);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .live-card:hover {
            border-color: #fb7185;
            background: rgba(251, 113, 133, 0.05);
        }

        .join-btn {
            background: #fb7185;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .join-btn:hover {
            background: #f43f5e;
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div><a href="/" class="logo">Missed Call Saviour <span
                        style="font-size: 0.7rem; opacity: 0.6; font-weight: normal;">v1.2</span></a>
                <div class="nav-menu">
                    <div class="menu-item active" onclick="showView('dashboard')"><span>üìä</span>Dashboard </div>
                    <div class="menu-item" onclick="showView('logs')"><span>üìû</span>Call Logs </div>
                    <div class="menu-item" onclick="showView('billing')"><span>üí≥</span>Billing </div>
                    <div class="menu-item" onclick="showView('settings')"><span>‚öôÔ∏è</span>Settings </div>
                    <div id="admin-sidebar-item" class="menu-item" onclick="showView('admin')"
                        style="display: none; border-top: 1px solid var(--glass-border); margin-top: 10px; color: #fbbf24;">
                        <span>üõ°Ô∏è</span>Admin Panel
                    </div>
                </div>
            </div>
            <div style="font-size: 0.8rem; color: #475569; text-align: center;">v2.3.5 (Stable) </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Welcome back,
                        <span id="user-email-header">Loading...</span>
                    </div>
                    <h2 id="page-title">Dashboard Overview</h2>
                </div>
                <div class="user-status">
                    <div id="plan-badge"
                        style="font-size: 0.85rem; color: #94a3b8; border: 1px solid #334155; padding: 4px 10px; border-radius: 6px;">
                        Free Plan</div>
                    <div id="status-badge" class="status-badge status-inactive">Inactive</div>
                </div>
            </header>
            <!-- DASHBOARD VIEW -->
            <div id="dashboard-view" class="view-section">
                <!-- Enhanced Grid Layout -->
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px;">
                    <!-- Stat 1 -->
                    <div class="stat-card glass-panel" style="position: relative; overflow: hidden;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:start; margin-bottom: 10px;">
                            <div class="stat-label">Missed Calls Saved</div>
                            <div
                                style="background:rgba(52, 211, 153, 0.2); padding:8px; border-radius:8px; font-size:1.2rem;">
                                üõ°Ô∏è</div>
                        </div>
                        <div class="stat-value">0</div>
                        <div
                            style="position: absolute; bottom: 0; right: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #34d399, transparent);">
                        </div>
                    </div>
                    <!-- Stat 2 -->
                    <div class="stat-card glass-panel" style="position: relative; overflow: hidden;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:start; margin-bottom: 10px;">
                            <div class="stat-label">Revenue Recovered</div>
                            <div
                                style="background:rgba(0, 198, 255, 0.2); padding:8px; border-radius:8px; font-size:1.2rem;">
                                üí∞</div>
                        </div>
                        <div class="stat-value"
                            style="background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                            0</div>
                        <div
                            style="position: absolute; bottom: 0; right: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #00c6ff, transparent);">
                        </div>
                    </div>
                    <!-- Stat 3 -->
                    <div class="stat-card glass-panel" style="position: relative; overflow: hidden;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:start; margin-bottom: 10px;">
                            <div class="stat-label">AI Success Rate</div>
                            <div
                                style="background:rgba(251, 191, 30, 0.2); padding:8px; border-radius:8px; font-size:1.2rem;">
                                ‚ö°</div>
                        </div>
                        <div class="stat-value">98%</div>
                        <div
                            style="position: absolute; bottom: 0; right: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #fbbf24, transparent);">
                        </div>
                    </div>
                </div>

                <!-- LIVE AI CONVERSATIONS SECTION -->
                <div id="live-calls-section" class="glass-panel"
                    style="display: none; padding: 20px; margin-bottom: 24px; border: 1px solid rgba(244, 63, 94, 0.3); background: rgba(244, 63, 94, 0.05); animation: fadeIn 0.5s ease;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3
                            style="margin: 0; font-size: 1.1rem; color: #fb7185; display: flex; align-items: center; gap: 10px;">
                            <span
                                style="width: 10px; height: 10px; background: #fb7185; border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite;"></span>
                            LIVE AI Conversations
                        </h3>
                        <span id="live-calls-count"
                            style="font-size: 0.8rem; background: #fb7185; color: white; padding: 2px 8px; border-radius: 99px;">0
                            Active</span>
                    </div>
                    <div id="live-calls-list"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                        <!-- Cards injected here -->
                    </div>
                </div>
                <!-- Middle Section: Chart+Actions -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div class="glass-panel" style="padding: 24px; min-height: 300px;">
                        <h3 style="margin-top:0; font-size: 1.1rem; margin-bottom: 16px;">Weekly
                            Call Volume</h3>
                        <div style="position: relative; height: 250px; width:100%"><canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-panel" style="padding: 24px;">
                        <h3 style="margin-top:0; font-size: 1.1rem; margin-bottom: 16px;">Quick
                            Actions</h3>
                        <div
                            style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; border: 1px solid var(--glass-border);">
                            <label style="font-size: 0.85rem; margin-bottom: 8px; display: block;">Test
                                Your Agent</label><input type="text" id="demoPhone"
                                placeholder="+91 98765 00000 (Use Country Code)"
                                style="margin-bottom: 12px; font-size: 0.9rem;"><button class="btn" id="demoBtn"
                                onclick="triggerDemoCall()"
                                style="width:100%; display: flex; align-items: center; justify-content: center; gap: 8px;"><span>üìû</span>Trigger
                                Call</button>
                            <button class="btn" onclick="fetchActiveCalls()"
                                style="width:100%; margin-top: 10px; background: rgba(52, 211, 153, 0.1); border: 1px solid rgba(52, 211, 153, 0.3); color: #34d399; font-size: 0.8rem;">
                                üîÑ Refresh Live List
                            </button>
                            <p
                                style="font-size: 0.75rem; color: var(--text-muted); margin-top: 12px; margin-bottom: 0; line-height: 1.4;">
                                Instantly requests a call from your AI to test its current greeting
                                and personality. </p>
                            <div id="demoMsg" style="margin-top: 10px; font-size: 0.8rem; display: none;"></div>
                        </div>

                        <div
                            style="margin-top: 16px; background: rgba(0, 198, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(0, 198, 255, 0.2);">
                            <label
                                style="font-size: 0.85rem; margin-bottom: 8px; display: block; color: #00c6ff; font-weight: bold;">‚ú®
                                Voice Cloning</label>
                            <button class="btn" onclick="showView('settings')"
                                style="width:100%; height: 40px; background: var(--primary-gradient); font-size: 0.85rem;">üéôÔ∏è
                                Setup My Asli Aawaz</button>
                            <p style="font-size: 0.7rem; color: #94a3b8; margin-top: 8px; margin-bottom: 0;">Click
                                here
                                to record your voice and clonoe it instantly.</p>
                        </div>
                    </div>
                </div>
                <!-- Recent Activity Table -->
                <div class="glass-panel" style="padding: 10px;">
                    <div
                        style="padding: 20px 24px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between;">
                        <h3 style="margin: 0; font-size: 1.1rem;">Recent Activity</h3>
                        <div style="font-size: 0.85rem; color: var(--text-muted); cursor: pointer;">
                            View All &rarr;
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Caller</th>
                                    <th>Time</th>
                                    <th>Resolution</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4"
                                        style="text-align: center; padding: 40px; color: var(--text-muted);">
                                        Loading recent calls... </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- CALL LOGS VIEW -->
            <div id="logs-view" class="view-section" style="display: none;">
                <div class="glass-panel" style="padding: 20px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <p style="color: #94a3b8; margin: 0;">Detailed history of all missed calls and
                            AI interactions. </p><button class="btn"
                            style="padding: 8px 16px; font-size: 0.9rem;">Export CSV</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Caller</th>
                                    <th>Duration</th>
                                    <th>Timestamp</th>
                                    <th>Transcript</th>
                                    <th>Outcome</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>#1092</td>
                                    <td>+1 (212) 555-0199</td>
                                    <td>1m 30s</td>
                                    <td>Today,
                                        10:45 AM</td>
                                    <td><a href="#" style="color: #00c6ff;">View Transcript</a></td>
                                    <td><span class="status-badge status-active">Booked Meeting</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>#1091</td>
                                    <td>+1 (415) 555-0123</td>
                                    <td>0m 45s</td>
                                    <td>Yesterday,
                                        4:20 PM</td>
                                    <td><a href="#" style="color: #00c6ff;">View Transcript</a></td>
                                    <td><span class="status-badge"
                                            style="background: rgba(56, 189, 248, 0.15); color: #38bdf8;">Sent
                                            Info</span></td>
                                </tr>
                                <tr>
                                    <td>#1090</td>
                                    <td>+1 (310) 555-0888</td>
                                    <td>2m 10s</td>
                                    <td>Oct 24,
                                        2:00 PM</td>
                                    <td><a href="#" style="color: #00c6ff;">View Transcript</a></td>
                                    <td><span class="status-badge status-inactive">Escalated</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- BILLING VIEW -->
            <div id="billing-view" class="view-section" style="display: none;">
                <div class="glass-panel" style="padding: 30px; max-width: 700px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); padding-bottom: 24px; margin-bottom: 24px;">
                        <div>
                            <h3 style="margin: 0 0 4px 0;">Current Subscription</h3>
                            <p style="margin: 0; color: var(--text-muted);">Next billing date: Nov
                                24,
                                2026</p>
                        </div><button
                            style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; cursor: pointer;">Cancel</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div
                            style="background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 6px; font-weight: 600;">
                            VISA</div>
                        <div style="font-family: monospace; font-size: 1.1rem; color: var(--text-muted);">
                            ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                    </div>
                </div>
            </div>
            <!-- SETTINGS VIEW -->
            <div id="settings-view" class="view-section" style="display: none;">
                <div class="glass-panel" style="padding: 30px; max-width: 800px;">
                    <h3 style="margin-top:0; border-bottom:1px solid var(--glass-border); padding-bottom:16px;">
                        AI Configuration</h3>
                    <div class="form-group"><label>Business Name</label><input type="text" id="ai-business-name"
                            placeholder="e.g. Rahul's Gym"></div>
                    <div class="form-group"><label>AI Greeting Message</label><textarea id="ai-greeting" rows="2"
                            placeholder="Namaste! Main Rahul's Gym se bol raha hu..."></textarea>
                    </div>
                    <div class="form-group"><label>AI Persona (Tone)</label><select id="ai-persona"
                            style="width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border); padding: 12px 16px; border-radius: 12px; color: white;">
                            <option value="friendly">Friendly (Indian English)</option>
                            <option value="professional">Professional (Formal Indian)</option>
                            <option value="urgent">High Energy (Sales Expert)</option>
                        </select></div>
                    <div class="form-group"
                        style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px;">
                        <label style="color: #34d399;">Your Real Mobile Number (For
                            Callbacks/Notifications)</label><input type="text" id="ai-owner-phone"
                            placeholder="+91 98765 43210">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 6px;">
                            We will use this to forward urgent leads or send you call alerts.
                        </p>
                    </div>

                    <div class="form-group"
                        style="background: rgba(0, 198, 255, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(0, 198, 255, 0.2); margin-top: 24px;">
                        <h4 style="margin-top: 0; color: #00c6ff; display: flex; align-items: center; gap: 8px;">
                            <span>üéôÔ∏è</span> Live Voice Cloning (ElevenLabs)
                        </h4>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
                            Make the AI agent sound exactly like you. Record your voice for 30 seconds or paste an
                            ElevenLabs Voice ID.
                        </p>

                        <div
                            style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed rgba(0, 198, 255, 0.3);">
                            <label style="color: #fff; margin-bottom: 10px; display: block; font-size: 0.9rem;">Record
                                Your Voice (30 seconds recommended)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button id="record-btn" class="btn"
                                    style="background: #ef4444; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); padding: 8px 16px; font-size: 0.85rem;"
                                    onclick="startRecording()">üî¥ Record</button>
                                <button id="stop-btn" class="btn"
                                    style="background: #64748b; display: none; padding: 8px 16px; font-size: 0.85rem;"
                                    onclick="stopRecording()">‚èπ Stop</button>
                                <div id="recording-timer"
                                    style="font-family: monospace; color: #ef4444; font-weight: bold; display: none;">
                                    00:00</div>
                            </div>
                            <div id="recording-preview" style="margin-top: 15px; display: none;">
                                <audio id="audio-playback" controls style="width: 100%; height: 35px;"></audio>
                                <button id="upload-voice-btn" class="btn"
                                    style="width: 100%; margin-top: 10px; background: var(--primary-gradient); padding: 10px; font-size: 0.9rem;"
                                    onclick="uploadRecording()">‚ú® Clone My Voice Now</button>
                            </div>
                            <p id="cloning-msg" style="margin-top: 10px; font-size: 0.8rem; display: none;"></p>
                        </div>

                        <div style="text-align: center; margin-bottom: 20px; color: #475569; position: relative;">
                            <span
                                style="background: rgba(30, 41, 59, 1); padding: 0 10px; position: relative; z-index: 1; font-size: 0.75rem;">OR
                                USE EXISTING ID</span>
                            <div
                                style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.1); z-index: 0;">
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label>ElevenLabs Voice ID</label>
                            <input type="text" id="ai-voice-id" placeholder="e.g. pMsXgVXv3BLzUgSgWJ5L">
                        </div>

                        <div>
                            <label>ElevenLabs API Key (Optional)</label>
                            <input type="password" id="ai-voice-api-key" placeholder="Paste your ElevenLabs API Key">
                            <p style="font-size: 0.75rem; color: #94a3b8; margin-top: 4px;">If left blank, system
                                default keys will be used if available.</p>
                        </div>
                    </div>
                    <!-- Activation Panel (Hidden by default) -->
                    <div id="activation-panel"
                        style="display: none; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 20px; border-radius: 12px; margin-top: 24px;">
                        <h4 style="margin-top: 0; color: #60a5fa;">üöÄ One Step to Go: Link
                            Your Phone</h4>
                        <p style="font-size: 0.9rem; color: #cbd5e1;">Choose one method to
                            connect your missed calls to AI:</p>
                        <!-- Method A -->
                        <div style="margin-bottom: 16px;"><strong
                                style="color: white; display:block; margin-bottom:4px;">Method
                                A: Call Forwarding (Simpler)</strong>
                            <div style="font-size: 0.85rem; color: #94a3b8;">Dial this
                                code on your phone to forward unanswered calls to your
                                AI Number (Check Vapi/Twilio for your assigned AI
                                number). <br><code
                                    style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; color: #fbbf24; margin-top:4px; display:inline-block;">**21*&lt;
        AI_PHONE_NUMBER&gt;
        #</code></div>
                        </div>
                        <!-- Method B -->
                        <div><strong style="color: white; display:block; margin-bottom:4px;">Method
                                B: Android App Automation (Reliable)</strong>
                            <div style="font-size: 0.85rem; color: #94a3b8;">Install
                                <b>MacroDroid</b>app. Create a macro: "Trigger: Call
                                Missed" ->"Action: HTTP
                                GET".
                                <br>Use this Magic URL:
                            </div>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <input type="text" id="webhook-url-box" readonly value="Loading..."
                                    style="font-size: 0.8rem; background: rgba(0,0,0,0.4); color: #a5b4fc;"><button
                                    class="btn" style="padding: 4px 12px; font-size: 0.8rem;"
                                    onclick="navigator.clipboard.writeText(document.getElementById('webhook-url-box').value); alert('Copied!');">Copy</button>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right; margin-top: 30px;"><button class="btn" onclick="updateAIConfig()"
                            id="save-config-btn">Save
                            Changes</button>
                        <p id="config-msg" style="margin-top: 10px; font-size: 0.9rem; display: none;"></p>
                    </div>
                </div>
            </div>
            <!-- ADMIN VIEW -->
            <div id="admin-view" class="view-section" style="display: none;">
                <div class="glass-panel" style="padding: 20px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <p style="color: #94a3b8; margin: 0;">System Overview & User
                            Management</p><button class="btn" onclick="fetchAdminUsers()"
                            style="padding: 8px 16px; font-size: 0.9rem;">üîÑ
                            Refresh</button>
                    </div>
                    <div class="table-container">
                        <table id="admin-users-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Business Name</th>
                                    <th>Plan</th>
                                    <th>Calls</th>
                                    <th>Agent Status</th>
                                    <th>Joined</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" style="text-align:center;">Loading
                                        users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Transcript Modal -->
        <div id="transcript-modal" class="glass-panel"
            style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 500px; padding: 0; box-shadow: 0 30px 60px rgba(0,0,0,0.6); overflow: hidden; border-radius: 20px;">
            <div class="chat-header"
                style="padding: 20px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.1rem;">Call Transcript</h3>
                <button onclick="closeModal()"
                    style="background: none; border: none; color: #fff; cursor: pointer; font-size: 1.5rem;">&times;</button>
            </div>
            <div id="modal-content"
                style="padding: 24px; max-height: 500px; overflow-y: auto; background: rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 16px;">
                Loading...
            </div>
            <div
                style="padding: 20px; text-align: right; background: rgba(0,0,0,0.2); border-top: 1px solid var(--glass-border);">
                <button class="btn" onclick="closeModal()" style="padding: 8px 24px;">Close</button>
            </div>
        </div>
        <div id="modal-overlay" onclick="closeModal()"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999;">
        </div>
        <script> // Check Auth and Load User Data

            async function initDashboard() {
                const token = localStorage.getItem('token');

                if (!token) {
                    console.log("No token found - redirecting to login");
                    window.location.href = '/login';
                    return;
                }

                try {

                    // Fetch User Info
                    const response = await fetch('/api/users/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const user = await response.json();
                        document.getElementById('user-email-header').innerText = user.email;
                        document.getElementById('plan-badge').innerText = user.plan + " Plan";

                        if (user.is_active) {
                            const statusBadge = document.getElementById('status-badge');

                            if (statusBadge) {
                                statusBadge.innerText = "Active";
                                statusBadge.className = "status-badge status-active";
                            }
                        }

                        // Admin Check
                        if (user.is_admin) {
                            const adminItem = document.getElementById('admin-sidebar-item');
                            if (adminItem) adminItem.style.display = 'flex';
                            // Fetch Admin Data if we are already in admin view (persisted state)
                            // But for now, just enable the button.
                        }



                        // Fetch Call Logs
                        fetchCallLogs(token);

                        // Fetch Dashboard Stats
                        fetchDashboardStats(token);

                        // Fetch AI Config
                        fetchAIConfig(token);

                        // Initialize Chart
                        renderChart();

                    }

                    else {
                        localStorage.removeItem('token');
                        window.location.href = '/login';
                    }
                }

                catch (e) {
                    console.error("Auth check failed", e);
                }
            }

            async function fetchDashboardStats(token) {
                try {
                    const response = await fetch('/api/dashboard/stats', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const stats = await response.json();

                        // Update Stat Cards
                        const statValues = document.querySelectorAll('.stat-value');

                        if (statValues.length >= 2) {
                            statValues[0].innerText = stats.missed_calls_saved;
                            statValues[1].innerText = "$" + stats.est_revenue.toLocaleString();
                            statValues[2].innerText = stats.engagement_rate;
                        }

                        // Update Recent Activity Table
                        const activityTbody = document.querySelector("#dashboard-view tbody");

                        if (activityTbody) {
                            activityTbody.innerHTML = "";

                            if (stats.recent_activity.length === 0) {
                                activityTbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color: #94a3b8;'>No recent calls. Start a demo!</td></tr>";
                                return;
                            }

                            stats.recent_activity.forEach(act => {
                                const timeAgo = getTimeAgo(new Date(act.time));

                                const row = `<tr>
                                                <td>${act.phone}</td>
                                                <td>${timeAgo}</td>
                                                <td>${act.recording_url ? 'Recorded Conversation' : 'Call Initiated'}</td>
                                                <td><span style="color: #34d399;">‚óè ${act.status}</span></td>
                                            </tr>`;
                                activityTbody.insertAdjacentHTML('beforeend', row);
                            });
                        }

                        // Update Chart with Real Data
                        if (stats.weekly_volume && stats.weekly_labels) {
                            renderChart(stats.weekly_labels, stats.weekly_volume);
                        }
                    }
                }

                catch (e) {
                    console.error("Failed to fetch dashboard stats", e);
                }
            }



            function getTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " years ago";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " months ago";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " days ago";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " hours ago";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " mins ago";
                return Math.floor(seconds) + " seconds ago";
            }

            async function fetchCallLogs(token) {
                try {
                    const response = await fetch('/api/calls', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const logs = await response.json();
                        window.allCallLogs = logs; // Store globally for modal access
                        renderCallLogs(logs);
                    }
                }

                catch (e) {
                    console.error("Failed to fetch logs", e);
                }
            }

            function renderCallLogs(logs) {
                const tbody = document.querySelector("#logs-view tbody");
                if (!tbody) return;

                tbody.innerHTML = "";

                if (logs.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No calls recorded yet.</td></tr>";
                    return;
                }

                logs.forEach(log => {
                    const date = new Date(log.timestamp).toLocaleString('en-IN', {
                        timeZone: 'Asia/Kolkata'
                    });
                    const statusColor = log.status === 'completed' ? 'status-active' : 'status-inactive';
                    const statusText = log.status === 'completed' ? 'Completed' : 'Failed';

                    // Format Duration
                    const duration = log.duration || 0;

                    const durationText = duration < 60 ? `${duration}s` : `${Math.floor(duration / 60)}m ${duration % 60}s`;

                    // Embedded Audio Player
                    const recordingPlayer = log.recording_url ? `<audio controls src="${log.recording_url}" style="height: 30px; width: 220px; border-radius: 20px;" ></audio>` : '<span style="color: #64748b;">No Audio</span>';

                    // View Summary Button (Safe ID-based open)
                    const summaryBtn = `<button onclick="openModal(${log.id})" style="background:none; border:none; color: #00c6ff; cursor: pointer; text-decoration: underline;" >View Call Details</button>`;

                    const row = `<tr>
                                    <td>#${log.id}</td>
                                    <td>${log.phone_number}</td>
                                    <td>${durationText}</td>
                                    <td>${date}</td>
                                    <td style="display:flex; align-items:center; gap:10px;">${recordingPlayer}${summaryBtn}</td>
                                    <td><span class="status-badge ${statusColor}">${statusText}</span></td>
                                </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }

            // Modal functions
            function openModal(logId) {
                const log = window.allCallLogs.find(l => l.id === logId);
                if (!log) return;

                const summary = log.summary || 'No summary available.';
                const transcript = log.transcript || 'No transcript available.';

                // Format Summary with "Graphics" (Emojis/Structure) if it's plain text
                let formattedSummary = summary;

                if (!summary.includes("<ul>") && !summary.includes("Topics:")) {
                    // Try to beautify plain text
                    formattedSummary = ` <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;"><p><strong>üìä Call Overview:</strong> ${summary}</p></div>`;
                }

                const chatHtml = formatTranscriptToChat(transcript);

                const htmlContent = `
                    <div style="margin-bottom: 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom:10px;">
                            <h4 style="margin:0; color: #94a3b8;">AI Summary & Insights</h4>
                            <div style="gap:10px; display:flex;">
                                <button onclick="reSummarizeCall(${log.id})" style="background:rgba(52, 211, 153, 0.1); border:1px solid rgba(52, 211, 153, 0.3); color:#34d399; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem;">üîÑ Re-analyze</button>
                                <button onclick="copyToClipboard('summary-text')" style="background:rgba(255,255,255,0.1); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem;">üìã Copy</button>
                                <button onclick="downloadTranscript(${log.id})" style="background:rgba(255,255,255,0.1); border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem;">‚¨áÔ∏è Download</button>
                            </div>
                        </div>
                        <div id="summary-text" style="color: #e2e8f0; font-size: 0.95rem; line-height:1.6; white-space: pre-wrap;">${formattedSummary}</div>
                    </div>
                    <div>
                        <h4 style="margin-top:0; color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Conversation Log</h4>
                        <div class="chat-container">${chatHtml}</div>
                    </div>
                `;

                document.getElementById('modal-content').innerHTML = htmlContent;
                document.getElementById('transcript-modal').style.display = 'block';
                document.getElementById('modal-overlay').style.display = 'block';
            }

            function formatTranscriptToChat(text) {
                if (!text || text === 'No transcript available.' || text.trim() === "") {
                    return '<div style="text-align:center; color:#64748b; padding:20px;">No conversation data available.</div>';
                }

                // If transcript is already HTML (legacy check), return as is
                if (text.trim().startsWith("<")) return text;

                const lines = text.split('\n');
                let html = '';

                // Fallback for blobs without newlines but with delimiters
                // e.g. "User: hi AI: hello"
                // This is a naive split if newlines are missing

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    let role = 'unknown';
                    let content = line;

                    // Detect Role
                    const lower = line.toLowerCase();

                    if (lower.startsWith("user:") || lower.startsWith("customer:") || lower.startsWith("caller:")) {
                        role = 'user';
                        content = line.replace(/^(User|Customer|Caller):\s*/i, "");
                    }

                    else if (lower.startsWith("ai:") || lower.startsWith("assistant:") || lower.startsWith("bot:")) {
                        role = 'ai';
                        content = line.replace(/^(AI|Assistant|Bot):\s*/i, "");
                    }

                    else {
                        // If no clear prefix, try to adhere to previous role or default to 'ai' if it looks like a system msg
                        // For now, let's treat unknown lines as 'ai' (or 'system') visually
                        role = 'ai';
                    }

                    const label = role === 'user' ? 'Caller' : 'AI Assistant';

                    html += ` <div class="chat-message ${role}" > <div class="chat-header" >${label}</div> <div class="chat-bubble" >${content}</div> </div> `;
                });

                return html;
            }



            function copyToClipboard(elementId) {
                const text = document.getElementById(elementId).innerText;

                navigator.clipboard.writeText(text).then(() => {
                    alert("Copied to clipboard!");
                });
            }

            function downloadTranscript(logId) {
                const log = window.allCallLogs.find(l => l.id === logId);
                if (!log) return;

                const content = `CALL SUMMARY:\n${log.summary}\n\nFULL TRANSCRIPT:\n${log.transcript}\n\n`;

                const blob = new Blob([content], {
                    type: 'text/plain'
                });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                a.download = `Call_Log_${logId}.txt`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            function closeModal() {
                document.getElementById('transcript-modal').style.display = 'none';
                document.getElementById('modal-overlay').style.display = 'none';
            }

            async function reSummarizeCall(callId) {
                const token = localStorage.getItem('token');
                const btn = event.target;
                const originalText = btn.innerText;

                btn.disabled = true;
                btn.innerText = "Summarizing...";

                try {
                    const response = await fetch(`/api/calls/${callId}/re-summarize`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('summary-text').innerText = data.summary;
                        btn.innerText = "Done!";
                        // Update local cache
                        const log = window.allCallLogs.find(l => l.id === callId);
                        if (log) log.summary = data.summary;
                    } else {
                        const err = await response.json();
                        alert("Error: " + (err.detail || "Failed to re-summarize"));
                        btn.innerText = "Failed";
                    }
                } catch (e) {
                    alert("Network Error: " + e.message);
                    btn.innerText = "Error";
                } finally {
                    setTimeout(() => {
                        if (btn) {
                            btn.disabled = false;
                            btn.innerText = "üîÑ Re-analyze";
                        }
                    }, 2000);
                }
            }

            window.onload = initDashboard;

            function showView(viewId) {
                const views = document.querySelectorAll('.view-section');
                views.forEach(view => view.style.display = 'none');

                const selectedView = document.getElementById(viewId + '-view');
                if (selectedView) selectedView.style.display = 'block';

                const titles = {
                    'dashboard': 'Dashboard Overview',
                    'logs': 'Call Logs & Transcripts',
                    'billing': 'Billing & Payments',
                    'settings': 'AI Configuration',
                    'admin': 'Admin Panel'
                }

                    ;
                const titleElem = document.getElementById('page-title');
                if (titleElem) titleElem.innerText = titles[viewId] || 'Dashboard';

                const menuItems = document.querySelectorAll('.menu-item');

                menuItems.forEach(item => {
                    item.classList.remove('active');

                    if (item.getAttribute('onclick').includes(viewId)) {
                        item.classList.add('active');
                    }
                });
            }

            async function triggerDemoCall() {
                const phone = document.getElementById('demoPhone').value;
                const btn = document.getElementById('demoBtn');
                const msg = document.getElementById('demoMsg');

                if (!phone) {
                    alert("Please enter a phone number");
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = "<span>‚è≥</span> Connecting...";
                msg.style.display = 'none';

                try {
                    const formData = new FormData();
                    formData.append('phone', phone);

                    const token = localStorage.getItem('token');

                    const response = await fetch('/api/send-demo-call', {

                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }

                        ,
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        msg.style.display = 'block';
                        msg.style.color = '#34d399';
                        msg.innerText = "Call initiated! Pickup your phone.";
                        btn.innerHTML = "<span>‚úÖ</span> Call Sent";
                    }

                    else {
                        throw new Error(data.details || "Failed");
                    }
                }

                catch (e) {
                    msg.style.display = 'block';
                    msg.style.color = '#ef4444';
                    msg.innerText = "Error: " + e.message;
                    btn.innerHTML = "<span>üìû</span> Trigger Call";
                }

                finally {
                    setTimeout(() => {
                        if (btn.innerText.includes("Sent")) {
                            btn.disabled = false;
                            btn.innerHTML = "<span>üìû</span> Trigger Call";
                        }

                        else {
                            btn.disabled = false;
                        }
                    }

                        , 5000);
                }
            }

            function renderChart(labels = [], counts = []) {
                if (typeof Chart === 'undefined') {
                    setTimeout(() => renderChart(labels, counts), 500); // Retry if CDN is slow
                    return;
                }

                const ctx = document.getElementById('weeklyChart');
                if (!ctx) return;

                // Check if chart instance exists
                if (window.myChart instanceof Chart) {
                    window.myChart.destroy();
                }

                Chart.defaults.color = '#94a3b8';
                Chart.defaults.font.family = "'Outfit', sans-serif";

                // If no data provided (initial load), default to empty or simple baseline
                if (!labels.length) {
                    labels = ['Mon',
                        'Tue',
                        'Wed',
                        'Thu',
                        'Fri',
                        'Sat',
                        'Sun'];
                    counts = [0,
                        0,
                        0,
                        0,
                        0,
                        0,
                        0];
                }

                const data = {

                    labels: labels,
                    datasets: [{
                        label: 'Missed Calls Handled',
                        data: counts,
                        borderColor: '#00c6ff',
                        backgroundColor: 'rgba(0, 198, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#00c6ff'
                    }

                    ]
                }

                    ;

                window.myChart = new Chart(ctx, {

                    type: 'line',
                    data: data,
                    options: {

                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }

                            ,
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#cbd5e1',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                padding: 10,
                                displayColors: false
                            }
                        }

                        ,
                        scales: {
                            y: {

                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }

                                , // Ensure integers for calls

                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                }

                                ,
                                border: {
                                    display: false
                                }
                            }

                            ,
                            x: {
                                grid: {
                                    display: false
                                }

                                ,
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Real-time Updates (SSE)
            function setupSSE(token) {
                if (!token) return;

                console.log("Initializing SSE connection...");
                const eventSource = new EventSource("/api/sse");

                eventSource.onopen = () => {
                    console.log("SSE Connected");
                };

                eventSource.onmessage = (event) => {
                    // Keep-alive ping
                    if (event.data === "ping") return;

                    if (event.data.includes("update_dashboard")) {
                        console.log("SSE: Dashboard Update Received");
                        // Refresh Data
                        fetchDashboardStats(token);
                        fetchCallLogs(token);
                        fetchActiveCalls(); // Add this
                    }
                };

                eventSource.onerror = (err) => {
                    // console.warn("SSE Connection lost/error. Retrying in 5s...", err);
                    eventSource.close();
                    setTimeout(() => setupSSE(token), 5000);
                };
            }

            // Start SSE if token exists
            const token = localStorage.getItem('token');
            if (token) {
                setupSSE(token);
                fetchActiveCalls(); // Initial check
                setInterval(fetchActiveCalls, 5000); // Poll every 5 seconds as fallback
            }

            async function fetchActiveCalls() {
                const token = localStorage.getItem('token');
                try {
                    const response = await fetch('/api/call-logs', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const logs = await response.json();
                        console.log("ALEX_DEBUG: Total Logs:", logs.length);
                        // Expanded active check: includes any status that isn't 'ended', 'completed', 'failed', 'no-answer'
                        const activeCalls = logs.filter(l => l.status && !['ended', 'completed', 'failed', 'no-answer', 'error'].includes(l.status.toLowerCase()));
                        console.log("ALEX_DEBUG: Active Calls Found:", activeCalls.length, activeCalls);

                        const section = document.getElementById('live-calls-section');
                        const list = document.getElementById('live-calls-list');
                        const count = document.getElementById('live-calls-count');

                        if (activeCalls.length > 0) {
                            section.style.display = 'block';
                            count.innerText = `${activeCalls.length} Active`;
                            list.innerHTML = activeCalls.map(call => `
                                <div class="live-card">
                                    <div>
                                        <div style="font-size: 0.9rem; font-weight: 600;">${call.phone_number}</div>
                                        <div style="font-size: 0.75rem; color: #fb7185; text-transform: capitalize;">${call.status}...</div>
                                    </div>
                                    <button class="join-btn" onclick="joinLiveCall('${call.vapi_call_id}')">üéôÔ∏è Join Call</button>
                                </div>
                            `).join('');
                        } else {
                            section.style.display = 'none';
                        }
                    }
                } catch (e) {
                    console.error("Active calls fetch error", e);
                }
            }

            async function joinLiveCall(vapiCallId) {
                if (!vapiCallId) {
                    alert("Call ID not captured yet. Please wait a second...");
                    return;
                }
                const token = localStorage.getItem('token');
                try {
                    const response = await fetch(`/api/calls/${vapiCallId}/join`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (data.monitor_url) {
                        window.open(data.monitor_url, '_blank');
                    } else {
                        alert(data.message || "Could not join call.");
                    }
                } catch (e) {
                    alert("Error joining call: " + e.message);
                }
            }


            async function fetchAIConfig(token) {
                try {
                    const response = await fetch('/api/ai-config', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const config = await response.json();
                        document.getElementById('ai-business-name').value = config.business_name || '';
                        document.getElementById('ai-greeting').value = config.greeting || '';
                        document.getElementById('ai-persona').value = config.persona || 'friendly';
                        document.getElementById('ai-owner-phone').value = config.owner_phone || '';
                        document.getElementById('ai-voice-id').value = config.eleven_labs_voice_id || '';
                        document.getElementById('ai-voice-api-key').value = config.eleven_labs_api_key || '';
                    }
                }

                catch (e) {
                    console.error("Failed to fetch AI config", e);
                }
            }

            async function updateAIConfig() {
                const btn = document.getElementById('save-config-btn');
                const msg = document.getElementById('config-msg');
                const token = localStorage.getItem('token');

                btn.disabled = true;
                btn.innerText = "Saving...";
                msg.style.display = 'none';

                const payload = {
                    business_name: document.getElementById('ai-business-name').value,
                    greeting: document.getElementById('ai-greeting').value,
                    persona: document.getElementById('ai-persona').value,
                    owner_phone: document.getElementById('ai-owner-phone').value,
                    eleven_labs_voice_id: document.getElementById('ai-voice-id').value,
                    eleven_labs_api_key: document.getElementById('ai-voice-api-key').value
                }

                    ;

                try {
                    const response = await fetch('/api/ai-config', {

                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }

                        ,
                        body: JSON.stringify(payload)
                    });

                    // Backend returns { detail: "..." } on error, { success: true } on success
                    const result = await response.json();

                    if (response.ok && result.success) {
                        msg.style.display = 'block';
                        msg.style.color = '#34d399';
                        msg.innerText = result.message;
                        btn.innerText = "Saved!";
                    }

                    else {
                        // Use 'detail' from backend if available, or 'error', or generic text
                        throw new Error(result.detail || result.error || "Failed to update settings.");
                    }
                }

                catch (e) {
                    msg.style.display = 'block';
                    msg.style.color = '#ef4444';
                    msg.innerText = "Error: " + e.message;
                    btn.innerText = "Save Changes";
                }

                finally {
                    setTimeout(() => {
                        if (btn.innerText === "Saved!") btn.innerText = "Save Changes"; btn.disabled = false;
                    }

                        , 3000);
                }
            }

            // --- Voice Recording Logic ---
            let mediaRecorder;
            let audioChunks = [];
            let timerInterval;
            let recordedBlob;

            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        recordedBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(recordedBlob);
                        const player = document.getElementById('audio-playback');
                        player.src = audioUrl;
                        document.getElementById('recording-preview').style.display = 'block';
                    };

                    mediaRecorder.start();
                    document.getElementById('record-btn').style.display = 'none';
                    document.getElementById('stop-btn').style.display = 'inline-block';
                    document.getElementById('recording-timer').style.display = 'inline-block';

                    let seconds = 0;
                    timerInterval = setInterval(() => {
                        seconds++;
                        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                        const secs = (seconds % 60).toString().padStart(2, '0');
                        document.getElementById('recording-timer').innerText = `${mins}:${secs}`;
                        if (seconds >= 60) stopRecording(); // Limit to 1 minute
                    }, 1000);

                } catch (err) {
                    alert("Error accessing microphone: " + err.message);
                }
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    clearInterval(timerInterval);
                    document.getElementById('stop-btn').style.display = 'none';
                    document.getElementById('record-btn').style.display = 'inline-block';
                    document.getElementById('record-btn').innerText = "üîÑ Re-record";
                    document.getElementById('recording-timer').style.display = 'none';
                }
            }

            async function uploadRecording() {
                const btn = document.getElementById('upload-voice-btn');
                const msg = document.getElementById('cloning-msg');
                const token = localStorage.getItem('token');
                const apiKey = document.getElementById('ai-voice-api-key').value;

                btn.disabled = true;
                btn.innerText = "‚è≥ Cloning Your Voice... (May take 30s)";
                msg.style.display = 'block';
                msg.style.color = '#94a3b8';
                msg.innerText = "Connecting to ElevenLabs API...";

                const formData = new FormData();
                formData.append('file', recordedBlob, 'voice_sample.wav');
                if (apiKey) formData.append('eleven_labs_api_key', apiKey);

                try {
                    const response = await fetch('/api/ai-config/clone-voice', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const result = await response.json();
                    if (response.ok) {
                        msg.style.color = '#34d399';
                        msg.innerText = "‚úÖ Voice Cloned Successfully!";
                        document.getElementById('ai-voice-id').value = result.voice_id;
                        btn.innerText = "Voice Cloned!";
                        // Trigger AI Settings save automatically
                        setTimeout(updateAIConfig, 1000);
                    } else {
                        throw new Error(result.detail || "Voice cloning failed.");
                    }
                } catch (e) {
                    msg.style.color = '#ef4444';
                    msg.innerText = "Error: " + e.message;
                    btn.disabled = false;
                    btn.innerText = "‚ú® Clone My Voice Now";
                }
            }



            async function fetchAdminUsers() {
                const token = localStorage.getItem('token');
                const tbody = document.querySelector("#admin-users-table tbody");

                try {
                    const response = await fetch('/api/admin/users', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const users = await response.json();
                        tbody.innerHTML = "";

                        if (users.length === 0) {
                            tbody.innerHTML = "<tr><td colspan='7' style='text-align:center;'>No users found.</td></tr>";
                            return;
                        }

                        users.forEach(u => {
                            const agentStatus = u.vapi_assistant_id && u.vapi_assistant_id !== "Not Created"
                                ? `<span style="color:#34d399;" >‚úÖ Deployed</span>` : `<span style="color:#fbbf24;" >‚ö†Ô∏è Pending</span>`;

                            const row = `<tr>
                                            <td>#${u.id}</td>
                                            <td>${u.email} ${u.is_admin ? 'üëë' : ''}</td>
                                            <td>${u.business_name}</td>
                                            <td><span class="tag info">${u.plan}</span></td>
                                            <td>${u.total_calls}</td>
                                            <td>${u.status}</td>
                                            <td>${agentStatus}</td>
                                            <td>${u.joined_at}</td>
                                            <td>${u.id === 1 ? '<span style="color:#64748b;">üîí</span>' : `<button onclick="deleteUser(${u.id})" style="background:rgba(239, 68, 68, 0.2); border:1px solid rgba(239, 68, 68, 0.5); color:#ef4444; border-radius:6px; cursor:pointer;">üóëÔ∏è</button>`}</td>
                                        </tr>`;
                            tbody.insertAdjacentHTML('beforeend', row);
                        });
                    }

                    else {
                        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color: #ef4444;">Failed to load users: $ {
                    response.status
                }

                (Try Logging Out)</td></tr>`;
                    }
                }

                catch (e) {
                    console.error("Admin fetch error", e);
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color: #ef4444;">Error loading data.</td></tr>`;
                }
            }

            async function deleteUser(userId) {
                if (!confirm("Are you sure you want to delete this user? This cannot be undone.")) return;

                const token = localStorage.getItem('token');

                try {
                    const response = await fetch(`/api/admin/users/${userId}`, {

                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        alert("User deleted!");
                        fetchAdminUsers(); // Refresh list
                    }

                    else {
                        const err = await response.json();
                        alert("Error: " + (err.detail || "Failed to delete"));
                    }
                }

                catch (e) {
                    alert("Network Error: " + e.message);
                }
            }

        </script>
        <script src="/chatbot.js"></script>
</body>

</html>